<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <!-- Á¶ÅÁî®Áº©ÊîæÔºå‰ºòÂåñÁßªÂä®Á´Ø‰ΩìÈ™å -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <!-- [ÂÖ≥ÈîÆ‰øÆÊîπ] Ê∑ªÂä† no-referrer Á≠ñÁï•ÔºåÂ∞ùËØïÁªïËøá Gitee Á≠âÂõΩÂÜÖÂõæÂ∫äÁöÑÈò≤ÁõóÈìæÊ£ÄÊü• -->
    <meta name="referrer" content="no-referrer">
    <title>Merry Christmas! üéÑ</title>  
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">  
  
    <style>  
        /* --- 1. Ê†∏ÂøÉÈÖçËâ≤‰∏éÂü∫Á°ÄËÆæÁΩÆ --- */  
        :root {  
            --bg-color: #FFFBF0;        
            --primary: #FF8FA3;         
            --secondary: #B5EAD7;       
            --text-color: #D4A373;      
            --accent: #FFE577;          
            --card-bg: #FFFFFF;  
            --paper-color: #FFF8E7;  
        }  
  
        * { margin: 0; padding: 0; box-sizing: border-box; }  
  
        body {  
            background-color: var(--bg-color);
            color: var(--text-color);  
            font-family: 'Nunito', 'Ma Shan Zheng', sans-serif;   
            overflow: hidden;   
            height: 100vh; height: 100dvh; width: 100vw;  
            cursor: default;   
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 1.2s cubic-bezier(0.4, 0, 0.2, 1); /* ËÉåÊôØËâ≤‰∏ùÊªëËøáÊ∏° */
        }  

        /* --- Countdown Lock Screen (Highest Priority) --- */
        #countdown-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color);
            /* High Z-Index to block normal content */
            z-index: 2000000000; 
            /* Flex centered. Removed !important to allow JS to hide it correctly */
            display: flex; 
            flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease;
        }
        .lock-icon { 
            font-size: 4rem; margin-bottom: 20px; 
            animation: swing 3s infinite ease-in-out;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1));
            cursor: pointer; /* Hint for interaction */
            user-select: none;
        }
        .lock-icon:active { transform: scale(0.9); }

        .countdown-title { 
            font-family: 'Ma Shan Zheng'; font-size: 1.4rem; color: #8d6e63; margin-bottom: 25px; 
            letter-spacing: 2px;
        }
        .countdown-timer {
            font-family: 'Fredoka One', monospace; font-size: 1.8rem; color: var(--primary);
            background: rgba(255,255,255,0.9); 
            padding: 20px 20px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 143, 163, 0.15);
            border: 3px dashed #FF8FA3;
            min-width: 280px; text-align: center;
            display: flex; justify-content: center; gap: 8px;
        }
        .timer-part { display: flex; flex-direction: column; align-items: center; width: 55px; }
        .timer-val { line-height: 1; }
        .timer-label { font-size: 0.6rem; color: #aaa; margin-top: 8px; font-family: sans-serif; font-weight: normal; }
        .timer-sep { opacity: 0.5; margin-top: -5px; }

        .countdown-tips {
            margin-top: 40px; font-size: 0.9rem; color: #bcaaa4; 
            font-family: 'Ma Shan Zheng'; opacity: 0.8;
            max-width: 80%; text-align: center; line-height: 1.6;
        }

        /* --- Bypass Modal (Higher than countdown) --- */
        #bypass-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000000001; /* Higher than countdown-layer */
            display: none;
            align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .bypass-box {
            background: white; padding: 30px; border-radius: 20px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 80%; max-width: 300px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .bypass-input {
            width: 100%; padding: 10px; margin: 20px 0;
            border: 2px solid #eee; border-radius: 10px;
            font-size: 1.2rem; text-align: center; font-family: 'Fredoka One';
            color: var(--primary); outline: none;
        }
        .bypass-input:focus { border-color: var(--primary); }
        .bypass-btns { display: flex; gap: 10px; justify-content: center; }
        .bypass-btn {
            padding: 8px 20px; border: none; border-radius: 20px;
            font-family: 'Ma Shan Zheng'; cursor: pointer; font-size: 1rem;
            transition: transform 0.1s;
        }
        .bypass-btn:active { transform: scale(0.95); }
        .btn-confirm { background: var(--primary); color: white; }
        .btn-cancel { background: #eee; color: #666; }


        /* --- Loading Screen (Optimized) --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            /* Default hidden, shown by JS if unlocked */
            display: none; 
            flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease-out;
        }
        
        /* Ë∑≥Âä®ÁöÑÁ§ºÁâ©ÂõæÊ†á */
        .loading-icon {
            font-size: 4.5rem;
            animation: bounceGift 1s infinite alternate ease-in-out;
            filter: drop-shadow(0 15px 15px rgba(255, 143, 163, 0.3));
            margin-bottom: 20px;
        }
        @keyframes bounceGift {
            0% { transform: translateY(0) scale(1); }
            100% { transform: translateY(-15px) scale(1.1); }
        }

        /* ËøõÂ∫¶Êù°ÂÆπÂô® */
        .loading-bar-container {
            width: 200px; height: 10px; background: #FFF0F5;
            border-radius: 20px; overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }

        /* ËøõÂ∫¶Êù°Êú¨‰Ωì */
        .loading-bar {
            width: 0%; height: 100%; 
            background: var(--primary);
            border-radius: 20px;
            transition: width 1.5s cubic-bezier(0.22, 0.61, 0.36, 1);
            /* Êù°Á∫πÂä®Áîª */
            background-image: linear-gradient(45deg,rgba(255,255,255,.2) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.2) 50%,rgba(255,255,255,.2) 75%,transparent 75%,transparent);
            background-size: 20px 20px;
            animation: progressStripes 1s linear infinite;
        }
        @keyframes progressStripes { from { background-position: 20px 0; } to { background-position: 0 0; } }

        .loading-text {
            margin-top: 15px; font-family: 'Ma Shan Zheng'; 
            color: var(--text-color); font-size: 1.1rem; 
            opacity: 0.9; letter-spacing: 1px;
        }

        /* --- Background Layers --- */
        
        /* 1. Âü∫Á°ÄËÉåÊôØÂ±Ç (Ê∏êÂèò/ÂõæÊ†á) */
        #bg-base-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; overflow: hidden;
            background: linear-gradient(-45deg, #fff5f5, #e8f5e9, #fffde7, #fff0f5);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            transition: opacity 1.5s ease;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 2. ÁâπÊïàÂ±Ç (ÂõûÂøÜ‰∏ìÂ±ûÂä®Áîª) */
        #theme-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none; overflow: hidden;
            transition: opacity 1s ease;
        }

        /* 3. ÂÖ®Â±ÄÈõ™Ëä±Â±Ç (ÈªòËÆ§ÊúÄ‰∏äÂ±ÇÔºå‰ΩÜ‰∏ç‰ºöÊå°‰ΩèÂºπÁ™ó) */
        #snow-container {  
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;  
            pointer-events: none; z-index: 2; 
        } 

        /* --- È°∂ÈÉ®Ë£ÖÈ•∞ --- */
        .light-rope {
            position: fixed; top: -15px; left: 0; width: 100%; height: 60px;
            z-index: 100; pointer-events: none;
            display: flex; justify-content: space-around;
            overflow: hidden;
            transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .light-rope.hidden { transform: translateY(-100px); }

        .light-bulb {
            position: relative; width: 16px; height: 36px; border-radius: 50%;
            background: #fff; margin-top: 10px;
            animation: swing 3s ease-in-out infinite alternate, glow 1.5s infinite alternate;
        }
        .light-bulb::before {
            content: ''; position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            width: 6px; height: 8px; background: #444;
        }
        .light-wire {
            position: absolute; top: -5px; left: 0; width: 100%; height: 25px;
            border-bottom: 2px solid #444; border-radius: 50%; z-index: 99;
        }
        .light-bulb:nth-child(2n) { background: #FF8FA3; box-shadow: 0 5px 15px rgba(255, 143, 163, 0.6); animation-delay: 0.2s; }
        .light-bulb:nth-child(2n+1) { background: #B5EAD7; box-shadow: 0 5px 15px rgba(181, 234, 215, 0.6); animation-delay: 0.5s; }
        .light-bulb:nth-child(3n) { background: #FFE577; box-shadow: 0 5px 15px rgba(255, 229, 119, 0.6); animation-delay: 0.8s; }
        @keyframes swing { 0% { transform: rotate(-3deg); } 100% { transform: rotate(3deg); } }
        @keyframes glow { 0% { opacity: 0.7; } 100% { opacity: 1; transform: scale(1.1); } }

        /* --- Music Control --- */
        #music-control {
            position: fixed; top: 20px; right: 20px;
            width: 44px; height: 44px; 
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 22px;
            transition: transform 0.2s;
            user-select: none;
        }
        #music-control:active { transform: scale(0.9); }
        #music-control.playing { animation: spin 4s linear infinite; color: var(--primary); }
        @keyframes spin { 100% { transform: rotate(360deg); } }
  
        /* --- Stage Layout (Container) --- */  
        .overlay-stage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            z-index: 500;
            /* ÈªòËÆ§ÈöêËóèÁä∂ÊÄÅ */
            opacity: 0; visibility: hidden; pointer-events: none;
            backdrop-filter: blur(0px); -webkit-backdrop-filter: blur(0px);
            /* ËΩ¨Âú∫Âä®ÁîªÈÖçÁΩÆ */
            transition: opacity 0.6s ease, backdrop-filter 0.6s ease, visibility 0.6s;
        }

        /* ÊøÄÊ¥ªÁä∂ÊÄÅ */
        .overlay-stage.active { 
            opacity: 1; visibility: visible; pointer-events: auto;
            backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
        }

        /* --- Dialog Box (Redesigned & Themed) --- */
        .dialog-box {  
            background-color: var(--paper-color);  
            width: 88%; max-width: 440px; padding: 40px 30px; 
            border-radius: 20px;  
            /* Default style */
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            position: relative; 
            max-height: 85vh; overflow-y: visible; 
            -webkit-overflow-scrolling: touch;
            z-index: 501;
            transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.6s ease, background-color 0.5s, border 0.5s, box-shadow 0.5s;
            
            transform: scale(0.8) translateY(30px); 
            opacity: 0;
        }

        /* Tape Style Pin (Default) */
        .dialog-pin {  
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%) rotate(-1.5deg);
            width: 110px; height: 32px; 
            background: rgba(255, 143, 163, 0.5); /* Primary semitransparent */
            backdrop-filter: blur(3px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-radius: 2px;
            z-index: 10;
        }  
        /* Tape texture */
        .dialog-pin::after {
            content: ''; position: absolute; inset: 0;
            background-image: linear-gradient(45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.2) 75%, transparent 75%, transparent);
            background-size: 10px 10px; opacity: 0.5;
        }

        /* ÂºπÁ™óÊøÄÊ¥ªÔºöÂõûÂºπÂà∞Ê≠£Â∏∏Â§ßÂ∞è */
        .overlay-stage.active .dialog-box { 
            transform: scale(1) translateY(0); 
            opacity: 1; 
        }
        .overlay-stage.exit .dialog-box {
            transform: scale(1.1) translateY(-10px);
            opacity: 0;
            transition: transform 0.5s ease-in, opacity 0.4s ease;
        }

        .dialog-content {  
            margin-top: 15px; font-family: 'Ma Shan Zheng', cursive; font-size: 1.35rem;  
            line-height: 1.8; color: #5d4037; text-align: left; min-height: 80px;
            transition: color 0.3s;
        }
        .typing-cursor::after { content: '|'; animation: blink 1s infinite; color: var(--primary); }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .action-btn {  
            background-color: var(--primary); color: white;  
            font-family: 'Fredoka One'; font-size: 1.1rem; letter-spacing: 1px;
            padding: 12px 32px; border: none; border-radius: 50px;  
            margin-top: 30px; cursor: pointer; float: right;  
            box-shadow: 0 4px 0 #d86c7f;  
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.3s;
            user-select: none;
        }  
        .action-btn:active { transform: translateY(4px); box-shadow: none; }  
        .action-btn.disabled { opacity: 0.6; pointer-events: none; filter: grayscale(1); }

        /* ================= THEME SPECIFIC DIALOG STYLES ================= */
        
        /* 1. Sakura (Spring/Pink) */
        .dialog-box.theme-sakura {
            background-color: #fff0f5;
            border: 3px solid #ffc1e3;
            box-shadow: 0 15px 30px rgba(255, 182, 193, 0.3);
        }
        .dialog-box.theme-sakura::before {
            content: 'üå∏'; position: absolute; top: -15px; right: -10px; font-size: 2rem; animation: rot 8s linear infinite;
        }
        .dialog-box.theme-sakura .dialog-pin { background: rgba(255, 105, 180, 0.4); }

        /* 2. Planes (Airmail) */
        .dialog-box.theme-planes {
            background-color: #fcfcfc;
            background-image: repeating-linear-gradient(135deg, #e3f2fd 0px, #e3f2fd 10px, #fff 10px, #fff 20px);
            border: 3px dashed #87ceeb;
            box-shadow: 10px 10px 0 rgba(135, 206, 235, 0.3);
        }
        .dialog-box.theme-planes .dialog-pin { background: rgba(65, 177, 225, 0.6); transform: translateX(-50%) rotate(2deg); }

        /* 3. Gaming (Dark/Neon) */
        .dialog-box.theme-gaming {
            background: #2d1b4e;
            border: 2px solid #00ff9d;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.3);
        }
        .dialog-box.theme-gaming h3 { color: #00ff9d !important; text-shadow: 0 0 8px rgba(0,255,157,0.5); }
        .dialog-box.theme-gaming .dialog-content { color: #e0e0e0; }
        .dialog-box.theme-gaming .action-btn { background: #7000ff; box-shadow: 0 4px 0 #4a00ac; }
        .dialog-box.theme-gaming .dialog-pin { display: none; }
        .dialog-box.theme-gaming::after {
            content: 'PRESS START'; position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
            background: #00ff9d; color: #2d1b4e; font-family: 'Fredoka One'; font-size: 0.8rem; padding: 2px 10px; border-radius: 4px;
        }

        /* 4. Warmth (Cozy Orange) */
        .dialog-box.theme-warmth {
            background: linear-gradient(to bottom, #fff8e1, #ffecb3);
            border: 4px solid #ffb74d;
            border-radius: 25px;
            box-shadow: 0 15px 30px rgba(255, 167, 38, 0.25);
        }
        .dialog-box.theme-warmth .dialog-content { color: #d84315; }
        .dialog-box.theme-warmth .dialog-pin { background: rgba(255, 167, 38, 0.5); }

        /* 5. Laugh (Pop Art) */
        .dialog-box.theme-laugh {
            background-color: #fff;
            background-image: radial-gradient(#fff176 20%, transparent 20%);
            background-size: 20px 20px;
            border: 4px solid #ffee58;
            box-shadow: 8px 8px 0 #fdd835;
        }
        .dialog-box.theme-laugh .action-btn { background: #fbc02d; box-shadow: 0 4px 0 #f57f17; color: #fff; }

        /* 6. Winter (Frosted) */
        .dialog-box.theme-winter {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 2px solid #b3e5fc;
            box-shadow: 0 0 25px rgba(179, 229, 252, 0.6);
        }
        .dialog-box.theme-winter h3 { color: #4fc3f7 !important; }
        .dialog-box.theme-winter .dialog-pin { background: rgba(179, 229, 252, 0.8); }

        /* 7. Stars (Night) */
        .dialog-box.theme-stars {
            background: linear-gradient(160deg, #1a237e, #3949ab);
            border: 1px solid #7986cb;
            box-shadow: 0 15px 40px rgba(26, 35, 126, 0.5);
        }
        .dialog-box.theme-stars h3 { color: #fff59d !important; }
        .dialog-box.theme-stars .dialog-content { color: #e8eaf6; }
        .dialog-box.theme-stars .action-btn { background: #5c6bc0; box-shadow: 0 4px 0 #3949ab; }
        .dialog-box.theme-stars .dialog-pin { background: #ffd54f; height: 12px; width: 12px; border-radius: 50%; top: 15px; box-shadow: 0 0 10px #ffd54f; opacity: 1; transform: translateX(-50%); border:none;}
        .dialog-box.theme-stars .dialog-pin::after { display: none; }

        /* 8. Balloons (Playful) */
        .dialog-box.theme-balloons {
            background: #fff;
            border: 5px solid;
            border-image: linear-gradient(to right, #ff9a9e, #fad0c4, #a18cd1) 1;
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        /* 9. Gold (Elegant) */
        .dialog-box.theme-gold {
            background: #fffbf0;
            border: 3px double #ffd700;
            box-shadow: 0 20px 50px rgba(218, 165, 32, 0.3);
        }
        .dialog-box.theme-gold h3 { color: #d4af37 !important; font-size: 1.6rem !important; }
        .dialog-box.theme-gold .dialog-pin { background: linear-gradient(45deg, #ffd700, #fdb931); opacity: 0.9; border: 1px solid #fff; }

        @keyframes rot { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }


        /* --- Heart Animation Layer (Optimized) --- */  
        #game-layer {  
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 600; pointer-events: none;   
        }  
        .msg-box {  
            position: absolute; width: 60px; height: 60px; 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            border-radius: 16px; 
            display: flex; align-items: center; justify-content: center;  
            text-align: center; padding: 2px; 
            font-size: 15px; font-weight: bold; color: #8d6e63; 
            /* ÁéªÁíÉÊãüÊÄÅÈò¥ÂΩ± */
            box-shadow: 
                0 4px 6px rgba(0,0,0,0.05), 
                inset 0 0 0 1px rgba(255,255,255,0.6),
                inset 0 2px 5px rgba(255,255,255,0.8);
            font-family: 'Ma Shan Zheng', cursive; 
            transition: all 0.8s cubic-bezier(0.25, 1, 0.5, 1);
            opacity: 0; transform: scale(0);
        }  
        /* ÊÇ¨ÊµÆÂëºÂê∏Âä®Áîª */
        .msg-box.floating { animation: boxFloat 3s ease-in-out infinite alternate; }
        @keyframes boxFloat { 0% { transform: translateY(0) scale(1); } 100% { transform: translateY(-6px) scale(1.05); } }
        
        /* Á≤íÂ≠êÁàÜÁÇ∏ (Á∫ØCSSÂÆûÁé∞) */
        .particle {
            position: absolute; width: 6px; height: 6px; border-radius: 50%;
            pointer-events: none; opacity: 0;
        }
        @keyframes explode { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }

        /* È¢úËâ≤ÈÖçÁΩÆ */
        .msg-box:nth-child(4n+1) { background: rgba(255, 209, 220, 0.95); color: #fff; }  
        .msg-box:nth-child(4n+2) { background: rgba(226, 240, 203, 0.95); color: #779966; }  
        .msg-box:nth-child(4n+3) { background: rgba(255, 245, 186, 0.95); color: #D4A373; }  
        .msg-box:nth-child(4n+4) { background: rgba(255, 255, 255, 0.95); color: #FF8FA3; border: 2px solid #FF8FA3; }  

        /* --- Photo Slideshow Layer (Optimized for Auto-Adapt) --- */
        .photo-frame {
            background: white;
            /* Bottom padding larger for Polaroid caption area */
            padding: 12px 12px 60px 12px; 
            box-shadow: 0 15px 30px rgba(0,0,0,0.25);
            
            /* Auto dimensions constraints - KEY CHANGE HERE */
            width: auto;
            height: auto;
            max-width: 85vw;
            max-height: 75vh;
            
            /* Flexbox to wrap content tightly around image */
            display: inline-flex; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            
            position: relative;
            opacity: 0; /* Transition handles fade in */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            
            border-radius: 4px; 
        }
        
        .photo-img {
            display: block;
            width: auto;
            height: auto;
            max-width: 100%; 
            /* Constrain height so it fits on mobile screens comfortably with the frame padding */
            max-height: 55vh; 
            object-fit: contain; 
            background-color: #fafafa; 
        }

        .photo-tape {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%) rotate(-2deg);
            width: 120px; height: 35px;
            background: rgba(255,255,255,0.4);
            backdrop-filter: blur(2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }

        /* Animation for swapping photos with dynamic rotation */
        .photo-frame.show {
            animation: photoFloat 6s ease-in-out infinite alternate;
            opacity: 1;
        }
        
        @keyframes photoFloat {
            /* Use CSS variable --rot set by JS for base rotation */
            0% { transform: rotate(var(--rot, -3deg)) scale(1); }
            100% { transform: rotate(calc(var(--rot, -3deg) + 3deg)) scale(1.02); }
        }

        /* --- Final Gift Card --- */  
        .welcome-card {  
            background: var(--card-bg); width: 90%; max-width: 450px; padding: 40px 30px;  
            border-radius: 30px; border: 4px dashed var(--primary);  
            box-shadow: 0 20px 50px rgba(212, 163, 115, 0.2); text-align: center;  
            /* ÈªòËÆ§‰∏ãÊ≤âÈöêËóè */
            transform: translateY(60px) scale(0.9); opacity: 0; 
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);   
        }  
        .overlay-stage.active .welcome-card { transform: translateY(0) scale(1); opacity: 1; }  
        /* Á¶ªÂú∫ */
        .overlay-stage.exit .welcome-card { transform: scale(0.8) opacity(0); transition: all 0.5s ease; }

        .ribbon { position: absolute; top: -10px; right: -10px; width: 80px; height: 80px; background: var(--secondary); border-radius: 50%; opacity: 0.5; z-index: -1; }  
        .memory-lane { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; margin-top: 20px;}  
        .polaroid { background: white; padding: 6px 6px 20px 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: rotate(-5deg); width: 90px; border: 1px solid #f0f0f0; }  
        .polaroid:nth-child(2) { transform: rotate(5deg) translateY(8px); }  
        .polaroid-img { width: 100%; height: 65px; background-color: #FFD1DC; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }  

        /* --- Final Scene (Completely Redesigned) --- */  
        #main-scene {  
            position: relative; z-index: 10; 
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            height: 100%; width: 100%;
            overflow: hidden;
            transition: opacity 1s ease, filter 1s ease; 
            filter: blur(10px); opacity: 0; pointer-events: none;
        }  
        #main-scene.active { filter: blur(0); opacity: 1; pointer-events: auto; }  
        
        /* [NEW] Scene Content Wrapper for auto-scaling */
        #scene-content-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transform-origin: bottom center;
            pointer-events: none; /* Pass through to children */
        }
        #scene-content-layer > * { pointer-events: auto; } /* Enable clicks for children */

        /* Scene Header */
        .scene-header {
            position: absolute; top: 10%; width: 100%;
            animation: floatTitle 4s ease-in-out infinite;
            z-index: 100; text-align: center;
        }
        @keyframes floatTitle { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .final-title {
            font-family: 'Fredoka One', 'Ma Shan Zheng', sans-serif; font-size: 3.2rem; 
            color: #FF8FA3; 
            text-shadow: 3px 3px 0px #fff, 0 0 20px rgba(255, 143, 163, 0.4);
            margin-bottom: 10px;
            line-height: 1.2;
        }
        .final-subtitle {
            color: #D4A373; font-weight: bold; font-size: 1.3rem;
            font-family: 'Ma Shan Zheng';
            background: rgba(255,255,255,0.6);
            padding: 6px 24px; border-radius: 20px;
            display: inline-block;
            backdrop-filter: blur(2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* --- ROOM DECORATIONS (Background Elements) --- */
        .room-decor-left {
            position: absolute; bottom: 80px; left: 5%;
            display: flex; flex-direction: column; align-items: center;
            z-index: 5; pointer-events: none;
        }
        .room-decor-right {
            position: absolute; bottom: 80px; right: 5%;
            display: flex; flex-direction: column; align-items: center;
            z-index: 5; pointer-events: none;
        }

        /* Fireplace */
        .fireplace {
            width: 120px; height: 100px;
            background: #8d6e63;
            border-radius: 4px;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: flex-end;
            border: 2px solid #5d4037;
        }
        .fireplace-inner {
            width: 70px; height: 60px;
            background: #3e2723;
            border-radius: 40px 40px 0 0;
            position: relative;
            overflow: hidden;
            display: flex; justify-content: center; align-items: flex-end;
        }
        .fire {
            font-size: 2rem; position: absolute; bottom: -5px;
            animation: fireBurn 0.5s infinite alternate;
            filter: drop-shadow(0 0 10px orange);
        }
        @keyframes fireBurn { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.1); opacity: 1; } }
        .mantel {
            position: absolute; top: -10px; left: -10px;
            width: 140px; height: 12px;
            background: #5d4037; border-radius: 4px;
            box-shadow: 0 2px 2px rgba(0,0,0,0.2);
        }
        .stocking {
            position: absolute; top: 2px; right: 10px;
            font-size: 1.5rem; transform: rotate(10deg);
        }

        /* Wall Frames */
        .wall-frame {
            width: 80px; height: 100px;
            background: #fff; border: 4px solid #d4a373;
            margin-bottom: 40px; /* Space above fireplace */
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: rotate(-2deg);
        }
        .wall-frame:nth-child(2) { width: 100px; height: 80px; transform: rotate(2deg); margin-bottom: 20px; }

        /* Bed */
        .cozy-bed {
            position: relative;
            width: 160px; height: 100px;
        }
        .bed-frame {
            position: absolute; bottom: 0; width: 100%; height: 40px;
            background: #fff0f5; border-radius: 8px;
            border: 2px solid #ff8fa3;
            box-shadow: 0 4px 5px rgba(0,0,0,0.1);
        }
        .bed-head {
            position: absolute; bottom: 40px; right: 0;
            width: 20px; height: 50px;
            background: #ff8fa3; border-radius: 4px;
        }
        .bed-blanket {
            position: absolute; bottom: 0; left: 0;
            width: 110px; height: 45px;
            background: #b5ead7;
            border-radius: 8px 0 0 8px;
        }
        .pillow {
            position: absolute; bottom: 45px; right: 25px;
            font-size: 1.8rem; transform: rotate(-5deg);
        }
        .cat-sleep {
            position: absolute; bottom: 35px; left: 30px;
            font-size: 1.8rem; z-index: 2;
        }

        /* Window */
        .wall-window {
            width: 100px; height: 100px;
            background: #2c3e50;
            border: 6px solid #fff;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }
        .wall-window::before {
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 4px;
            background: #fff; transform: translateY(-50%);
        }
        .wall-window::after {
            content: ''; position: absolute; left: 50%; top: 0; height: 100%; width: 4px;
            background: #fff; transform: translateX(-50%);
        }
        .moon-view {
            position: absolute; top: 10px; right: 10px; font-size: 1.2rem;
        }

        /* Floor Rug */
        .rug {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 500px; height: 120px;
            background: radial-gradient(ellipse at center, #d7ccc8, transparent 70%);
            border-radius: 50%;
            z-index: 4; /* Behind tree(10) and decor(5) */
            opacity: 0.6;
            pointer-events: none;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .room-decor-left { left: -30px; transform: scale(0.7); transform-origin: bottom left; }
            .room-decor-right { right: -30px; transform: scale(0.7); transform-origin: bottom right; }
            .wall-frame { display: none; } /* Simplify for mobile */
            .wall-window { margin-bottom: 10px; width: 80px; height: 80px; }
            .rug { width: 350px; }
        }

        /* --- GIANT TREE & 3D ORBIT SYSTEM --- */
        
        /* The Central Stage */
        .center-stage {
            position: absolute; bottom: 100px; /* Lifted from 60px for mobile thumb access */
            left: 50%;
            transform: translateX(-50%);
            width: 300px; height: 500px;
            display: flex; justify-content: center; align-items: flex-end;
            pointer-events: none; /* Container passes clicks */
        }
        @media (max-height: 700px) {
            .center-stage { bottom: 80px; }
        }

        /* The Giant Tree */
        .giant-tree {
            font-size: 22rem; line-height: 1;
            filter: drop-shadow(0 10px 20px rgba(0,50,0,0.3));
            position: relative; z-index: 10; /* Middle Layer */
            transform-origin: bottom center;
            animation: treeBreath 4s ease-in-out infinite alternate;
            pointer-events: none; /* [FIX] Allow clicks to pass through transparent parts of emoji */
        }
        @keyframes treeBreath { 0% { transform: scale(1); } 100% { transform: scale(1.02); } }

        /* The Star on top (Axis of Rotation) */
        .tree-star {
            position: absolute; top: 40px; left: 50%; 
            transform: translateX(-50%);
            font-size: 4rem; z-index: 11;
            filter: drop-shadow(0 0 15px gold);
            animation: starTwinkle 1.5s infinite alternate;
            pointer-events: none;
        }
        @keyframes starTwinkle { 0% { opacity: 0.8; transform: translateX(-50%) scale(1); } 100% { opacity: 1; transform: translateX(-50%) scale(1.2); } }

        /* --- 3D ORBIT BALLOON --- */
        .orbit-container {
            position: absolute; 
            top: 80px; /* Align with star roughly */
            left: 50%;
            width: 0; height: 0;
            z-index: 20;
            pointer-events: none;
        }

        .balloon-wrapper {
            position: absolute; top: -90px; left: -60px;
            width: 120px; height: 180px;
            cursor: pointer;
            pointer-events: auto; /* [FIX] Re-enable clicks */
            will-change: transform, z-index;
            animation: orbit3D 20s linear infinite;
        }
        /* Pause on hover */
        .balloon-wrapper:hover { animation-play-state: paused; }

        /* 
           Perspective Logic:
           0%   : Front (z: 20), Scaled Up, Lower Y
           25%  : Right (z: 10), Normal Scale, Higher Y
           50%  : Back (z: 5), Scaled Down, Highest Y (Behind Tree Tip)
           75%  : Left (z: 10), Normal Scale, Higher Y
           100% : Front
        */
        @keyframes orbit3D {
            0% { 
                z-index: 20; 
                transform: translateX(0px) translateY(20px) scale(1.2); 
            }
            25% { 
                z-index: 9; 
                transform: translateX(160px) translateY(-10px) scale(0.9); 
            }
            50% { 
                z-index: 5; /* Behind Tree (Tree is 10) */
                transform: translateX(0px) translateY(-30px) scale(0.7); 
            }
            75% { 
                z-index: 9; 
                transform: translateX(-160px) translateY(-10px) scale(0.9); 
            }
            100% { 
                z-index: 20; 
                transform: translateX(0px) translateY(20px) scale(1.2); 
            }
        }
        
        @media (max-width: 450px) {
            @keyframes orbit3D {
                0% { z-index: 20; transform: translateX(0px) translateY(20px) scale(1.1); }
                25% { z-index: 9; transform: translateX(110px) translateY(-10px) scale(0.85); }
                50% { z-index: 5; transform: translateX(0px) translateY(-30px) scale(0.65); }
                75% { z-index: 9; transform: translateX(-110px) translateY(-10px) scale(0.85); }
                100% { z-index: 20; transform: translateX(0px) translateY(20px) scale(1.1); }
            }
            .giant-tree { font-size: 18rem; }
            .center-stage { bottom: 110px; }
        }

        /* Balloon Graphics (Same as before) */
        .hot-air-balloon {
            position: relative; display: flex; flex-direction: column; align-items: center;
            transition: transform 0.3s;
        }
        .hot-air-balloon.anim-shake { animation: shakeBalloon 0.5s ease-in-out; }

        .balloon-body {
            width: 100px; height: 120px;
            background: radial-gradient(circle at 30% 30%, #fff, var(--primary));
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            position: relative; overflow: hidden;
            box-shadow: inset -10px -10px 20px rgba(0,0,0,0.1), 5px 10px 20px rgba(0,0,0,0.1);
            z-index: 2;
        }
        .balloon-body::before {
            content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 16px; height: 100%; background: var(--secondary); opacity: 0.6;
            border-radius: 50%;
        }
        .balloon-body::after {
            content: ''; position: absolute; top: 40%; left: 0; width: 100%; height: 12px;
            background: var(--accent); opacity: 0.8; transform: rotate(-5deg);
        }
        .balloon-ropes {
            width: 30px; height: 15px; 
            border-left: 2px solid #8d6e63; border-right: 2px solid #8d6e63;
            margin-top: -4px; position: relative; z-index: 1;
        }
        .balloon-basket {
            width: 36px; height: 28px; background: #8d6e63;
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; position: relative; z-index: 2;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            background-image: linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1) 75%, transparent 75%, transparent);
            background-size: 8px 8px;
        }
        /* [FIX] Larger hit area for secret trigger */
        .balloon-basket::before {
            content: ''; position: absolute;
            top: -30px; left: -30px; right: -30px; bottom: -30px;
            z-index: 10;
        }
        .balloon-basket:active { transform: scale(0.9); }
        .balloon-basket::after {
            content: 'üéÅ'; position: absolute; top: -8px; font-size: 1.1rem;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }

        @keyframes shakeBalloon {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        /* Falling Stars */
        .falling-star {
            position: fixed; 
            color: #FFD700; font-size: 1.2rem;
            pointer-events: none; z-index: 30; /* Must fall in front */
            animation: starDrop 1.5s linear forwards;
            text-shadow: 0 0 5px #fff;
        }
        @keyframes starDrop {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translateY(150px) rotate(180deg) scale(0.5); opacity: 0; }
        }

        /* --- DOLLS AT THE BASE --- */
        .dolls-wrapper {
            position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: flex-end; justify-content: center;
            z-index: 20; /* Front of tree */
            width: 100%; max-width: 500px;
            pointer-events: none; /* Wrapper passes clicks */
        }
        
        .doll-item {
            position: relative;
            font-size: 3.5rem;
            margin: 0 -5px;
            cursor: pointer;
            transition: transform 0.2s;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
            user-select: none;
            pointer-events: auto; /* [FIX] Enable clicks on items */
        }
        /* [FIX] Large hit area for dolls */
        .doll-item::before {
            content: ''; position: absolute;
            top: -20px; left: -10px; right: -10px; bottom: -10px;
            z-index: 1;
        }
        
        /* Arc effect via margins and translateY */
        .doll-item:nth-child(1) { transform: translateY(-10px) rotate(-10deg); margin-right: 10px; }
        .doll-item:nth-child(2) { transform: translateY(-5px) rotate(-5deg); margin-right: 5px; }
        .doll-item:nth-child(3) { transform: translateY(0) scale(1.1); z-index: 21; }
        .doll-item:nth-child(4) { transform: translateY(-5px) rotate(5deg); margin-left: 5px; }
        .doll-item:nth-child(5) { transform: translateY(-10px) rotate(10deg); margin-left: 10px; }

        .doll-item:active { transform: scale(0.9) !important; }
        .doll-item:hover { filter: drop-shadow(0 8px 10px rgba(0,0,0,0.3)) brightness(1.1); }
        
        .doll-jump { animation: dollJump 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes dollJump { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-30px); } }

        /* Pop-up Bubble (Shared) */
        .pop-bubble {
            position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
            background: #fff; padding: 6px 12px; border-radius: 12px;
            font-size: 0.9rem; color: #FF8FA3; font-weight: bold;
            white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            opacity: 0; pointer-events: none; font-family: 'Fredoka One', 'Ma Shan Zheng';
            z-index: 100; transition: none;
        }
        .pop-bubble.show { animation: popShow 3s forwards; }
        @keyframes popShow { 
            0% { opacity: 0; transform: translate(-50%, 10px) scale(0.8); } 
            10% { opacity: 1; transform: translate(-50%, 0) scale(1); } 
            80% { opacity: 1; transform: translate(-50%, -15px); }
            100% { opacity: 0; transform: translate(-50%, -40px); } 
        }
        .pop-bubble::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px;
            border-width: 6px 6px 0; border-style: solid; border-color: #fff transparent transparent transparent;
        }

        /* Flying Sleigh (Still in bg) */
        .sleigh-container {
            position: absolute; top: 12%; left: -300px;
            font-size: 2rem; opacity: 0.8; pointer-events: none; z-index: 1;
        }
        .sleigh-container.fly { animation: sleighRide 12s linear forwards; }
        @keyframes sleighRide {
            0% { transform: translateX(0) translateY(0) rotate(5deg); left: -300px; }
            25% { transform: translateX(25vw) translateY(20px) rotate(0deg); }
            50% { transform: translateX(50vw) translateY(0) rotate(-5deg); }
            75% { transform: translateX(75vw) translateY(20px) rotate(0deg); }
            100% { transform: translateX(100vw) translateY(0) rotate(5deg); left: 100vw; }
        }

        .snow-ground { position: fixed; bottom: -40px; left: 0; width: 100%; height: 120px; background: white; border-radius: 50% 50% 0 0 / 100% 100% 0 0; transform: scaleX(1.5); z-index: 2; transition: transform 1s ease; }  
        
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(105vh) rotate(360deg); opacity: 0; } }  
        .snowflake { position: absolute; background: white; border-radius: 50%; opacity: 0.8; pointer-events: none; } 
        
        /* Èó™ÂÖâËΩ¨Âú∫‰ºòÂåñ */
        #flash-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; z-index: 9999; pointer-events: none; 
            opacity: 0; transition: opacity 1.5s ease-in-out; 
        }

        /* =========================================
           THEME ANIMATIONS (Unique for each memory)
           ========================================= */
        /* Theme 1: Sakura (ÂàùËØÜ) */
        .fx-sakura { position: absolute; font-size: 1.5rem; animation: sakuraFall linear infinite; opacity: 0.8; }
        @keyframes sakuraFall { 0% { transform: translateY(-10vh) rotate(0deg) translateX(0); } 100% { transform: translateY(110vh) rotate(360deg) translateX(20px); } }

        /* Theme 2: Paper Plane (ÂàÜ‰∫´) */
        .fx-plane { position: absolute; font-size: 2.5rem; animation: planeFly linear infinite; opacity: 0.9; }
        @keyframes planeFly { 
            0% { transform: translate(-20vw, 10vh) rotate(10deg) scale(0.5); opacity: 0; } 
            20% { opacity: 1; }
            100% { transform: translate(120vw, -30vh) rotate(-10deg) scale(1); opacity: 1; } 
        }

        /* Theme 3: Gaming (Ê∏∏Êàè) */
        .fx-game-icon { position: absolute; font-size: 3rem; animation: gamePop infinite alternate; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); }
        .fx-game-vs { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 15rem; font-weight: 900; color: rgba(255,255,255,0.05); font-family: 'Fredoka One'; animation: pulseVs 2s infinite; }
        @keyframes gamePop { 0% { transform: scale(1) rotate(-5deg); } 100% { transform: scale(1.1) rotate(5deg); } }
        @keyframes pulseVs { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.05); } }

        /* Theme 4: Warmth (ÊîØÊíë) */
        .fx-warm-glow { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80vw; height: 80vw; background: radial-gradient(circle, rgba(255, 165, 0, 0.3) 0%, rgba(255, 255, 255, 0) 70%);
            border-radius: 50%; animation: warmPulse 4s infinite ease-in-out;
        }
        @keyframes warmPulse { 0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); } }

        /* Theme 5: Laughter (Ê¨¢Á¨ë) */
        .fx-laugh { position: absolute; font-size: 2.5rem; animation: floatBubble linear infinite; }
        @keyframes floatBubble { 0% { transform: translateY(110vh) scale(0.5); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-10vh) scale(1.2); opacity: 0; } }

        /* Theme 6: Winter (ËøáÂÜ¨) */
        .fx-frost { position: absolute; inset: 0; box-shadow: inset 0 0 100px rgba(200, 230, 255, 0.8); pointer-events: none; z-index: 10; }

        /* Theme 7: Stars (ËÆ∏ÊÑø) */
        .fx-star { position: absolute; background: white; border-radius: 50%; animation: twinkle 2s infinite alternate; }
        .fx-shooting-star { 
            position: absolute; width: 100px; height: 2px; background: linear-gradient(90deg, white, transparent);
            transform: rotate(-45deg); animation: shootStar 3s linear infinite; opacity: 0;
        }
        @keyframes twinkle { 0% { opacity: 0.3; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1.2); } }
        @keyframes shootStar { 0% { transform: translate(0, 0) rotate(-45deg); opacity: 1; } 20% { opacity: 1; } 100% { transform: translate(-50vw, 50vh) rotate(-45deg); opacity: 0; } }

        /* Theme 8: Balloons (Èô™‰º¥) */
        .fx-balloon { position: absolute; font-size: 3rem; animation: balloonRise linear infinite; }
        @keyframes balloonRise { 0% { transform: translateY(110vh) translateX(0); } 50% { transform: translateY(50vh) translateX(20px); } 100% { transform: translateY(-20vh) translateX(-20px); } }

        /* Theme 9: Golden (Á•ùÁ¶è) */
        .fx-gold { position: absolute; width: 6px; height: 6px; background: #FFD700; border-radius: 50%; animation: goldRain linear infinite; box-shadow: 0 0 5px #FFD700; }
        @keyframes goldRain { 0% { transform: translateY(-10px); opacity: 1; } 100% { transform: translateY(110vh); opacity: 0; } }

    </style>  
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>  
<body>  
    
    <!-- [NEW] Subtle Debug Info (Top Left, Low Opacity) -->
    <div id="res-debug" style="position:fixed; top:4px; left:4px; font-size:10px; opacity:0.2; color:#000; z-index:10001; pointer-events:none; font-family:sans-serif;">Init...</div>

    <!-- ÂÄíËÆ°Êó∂Â±Ç (Lock Screen) -->
    <!-- Priority 1: Max Z-Index and Inline Display Force -->
    <div id="countdown-layer">
        <div class="lock-icon" id="lock-btn">üîí</div>
        <div class="countdown-title">Á§ºÁâ©Ê¥æÈÄÅ‰∏≠...</div>
        <div class="countdown-timer">
            <div class="timer-part"><span class="timer-val" id="cd-d">00</span><span class="timer-label">DAYS</span></div>
            <div class="timer-sep">:</div>
            <div class="timer-part"><span class="timer-val" id="cd-h">00</span><span class="timer-label">HRS</span></div>
            <div class="timer-sep">:</div>
            <div class="timer-part"><span class="timer-val" id="cd-m">00</span><span class="timer-label">MIN</span></div>
            <div class="timer-sep">:</div>
            <div class="timer-part"><span class="timer-val" id="cd-s">00</span><span class="timer-label">SEC</span></div>
        </div>
        <div class="countdown-tips">
            Áé∞Âú®Ëøò‰∏çËÉΩÂÅ∑ÁúãÂì¶<br>ËØ∑ËÄêÂøÉÁ≠âÂæÖÂåó‰∫¨Êó∂Èó¥ 12Êúà25Êó• 00:00
        </div>
    </div>

    <!-- ÂØÜÁ†ÅÈ™åËØÅÂºπÁ™ó (Bypass Modal) -->
    <div id="bypass-modal">
        <div class="bypass-box">
            <h3 style="color: #8d6e63; font-family: 'Ma Shan Zheng'; margin-bottom: 10px;">üîí ÁßòÂØÜÈÄöÈÅì</h3>
            <div style="font-size: 0.9rem; color: #bbb; margin-bottom: 15px;">ËØ∑ËæìÂÖ•ÊöóÂè∑ÂºÄÂêØÂõûÂøÜ</div>
            <input type="tel" id="bypass-input" class="bypass-input" maxlength="4" placeholder="****">
            <div class="bypass-btns">
                <button class="bypass-btn btn-cancel" onclick="closeBypass()">ÂèñÊ∂à</button>
                <button class="bypass-btn btn-confirm" onclick="checkBypass()">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>

    <!-- ËµÑÊ∫êÂä†ËΩΩÈ°µ (Optimized) -->
    <div id="loading-screen">
        <div class="loading-icon">üéÅ</div>
        <div class="loading-bar-container">
            <div class="loading-bar" id="loading-bar"></div>
        </div>
        <div class="loading-text">Ê≠£Âú®ÊâìÂåÖÁæéÂ•ΩÁöÑÂõûÂøÜ...</div>
    </div>

    <!-- È°∂ÈÉ®ÂΩ©ÁÅØË£ÖÈ•∞ -->
    <div class="light-rope">
        <div class="light-wire"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
    </div>

    <!-- 0. Âü∫Á°ÄÊ∏êÂèòËÉåÊôØ -->
    <div id="bg-base-layer"></div>

    <!-- 1. ‰∏ªÈ¢òÁâπÊïàÂ±Ç (ÂõûÂøÜÊó∂Âä®ÊÄÅÂèòÂåñ) -->
    <div id="theme-layer"></div>

    <!-- 2. ÂÖ®Â±ÄÈõ™Ëä±Â±Ç -->
    <div id="snow-container"></div>  

    <!-- Èó™ÂÖâËΩ¨Âú∫Â±Ç -->
    <div id="flash-overlay"></div>

    <!-- ËÉåÊôØÈü≥‰πê (È¢ÑÂä†ËΩΩ) -->
    <audio id="bgm" loop preload="auto">
        <!-- ÊõøÊç¢‰∏∫ÂõΩÂÜÖÂèØËÆøÈóÆÁöÑÁΩëÊòì‰∫ëÈü≥‰πêÁõ¥Èìæ -->
        <source src="https://music.163.com/song/media/outer/url?id=478507889.mp3" type="audio/mpeg">
    </audio>
    <div id="music-control" onclick="toggleMusic(event)">üéµ</div>
  
    <!-- Â∫èÁ´† -->  
    <div id="stage-0-intro" class="overlay-stage">  
        <div class="dialog-box">  
            <div class="dialog-pin"></div>  
            <h3 style="color: #D4A373; font-size: 1.5rem; font-family: 'Fredoka One'; margin-bottom: 10px;">  
                To: ÊúÄÂèØÁà±ÁöÑÂ∞èËÉ°ÂêåÂ≠¶ üìù  
            </h3>  
            <div class="dialog-content" id="intro-text"></div>  
            <button class="action-btn disabled" id="btn-intro" onclick="startMemories()">ÂºÄÂêØÂõûÂøÜ &gt;</button>  
        </div>  
    </div>  
  
    <!-- ÂõûÂøÜÊí≠ÊîæÂô® -->  
    <div id="stage-1-memory" class="overlay-stage">  
        <div class="dialog-box">  
            <div class="dialog-pin"></div>  
            <h3 id="mem-title" style="color: #D4A373; font-size: 1.4rem; font-family: 'Fredoka One';"></h3>  
            <div class="dialog-content typing-cursor" id="mem-text"></div>  
            <button class="action-btn disabled" id="btn-mem" onclick="nextMemory()">‰∏ã‰∏ÄÊ≠• &gt;</button>  
        </div>
    </div>  
  
    <!-- Ê∏∏ÊàèÂºïÂØº -->  
    <div id="stage-2-invite" class="overlay-stage">  
        <div class="dialog-box">  
            <div class="dialog-pin"></div>  
            <h3 style="color: #D4A373; font-size: 1.5rem; font-family: 'Fredoka One'; margin-bottom: 10px;">  
                To: ÊúÄÂèØÁà±ÁöÑÂ∞èËÉ°ÂêåÂ≠¶ üìù  
            </h3>  
            <div class="dialog-content" id="invite-text"></div>  
            <!-- ÂÖ®Ëá™Âä®Ê®°ÂºèÔºåÈöêËóèÊåâÈíÆ -->
            <button class="action-btn disabled" id="btn-invite" style="display:none;">  
                Êé•Êî∂Á•ùÁ¶è ‚ú®  
            </button>  
        </div>  
    </div>  
  
    <!-- Áà±ÂøÉÂä®ÁîªÂ±Ç -->  
    <div id="game-layer"></div>  
  
    <!-- Memory Photo Slideshow -->
    <div id="stage-photo-gallery" class="overlay-stage">
        <div class="photo-frame" id="photo-frame">
            <div class="photo-tape"></div>
            <img id="photo-display" class="photo-img" src="" alt="Memory" />
        </div>
    </div>

    <!-- Á§ºÁâ©Âç°Áâá -->  
    <div id="stage-3-card" class="overlay-stage">  
        <div class="welcome-card">  
            <div class="ribbon"></div>  
            <h2 class="card-title">To: ‰∫≤Áà±ÁöÑ‰Ω† ‚ú®</h2>  
            <p class="card-text" style="font-size: 1.2rem;">  
                ÈõÜÈΩêÂï¶ÔºÅ<br>ÊØè‰∏Ä‰∏™ÊñπÂùóÈÉΩÊòØÊàëÁöÑÂøÉÊÑè„ÄÇ<br>Âú£ËØûÂø´‰πêÔºÅ  
            </p>  
            <div class="memory-lane">  
                <div class="polaroid"><div class="polaroid-img">üç¨</div></div>  
                <div class="polaroid"><div class="polaroid-img">üåü</div></div>  
            </div>  
            <button class="action-btn" style="float:none;" onclick="revealFinal()">ÊãÜÂºÄÁ§ºÁâ© üéÅ</button>  
        </div>  
    </div> 
    
    <!-- Secret Code Modal (Hidden by default) -->
    <div id="secret-modal" class="overlay-stage" style="z-index: 2000;">
        <div class="dialog-box" style="text-align: center;">
            <div class="dialog-pin"></div>
            <h3 style="color: #FF8FA3; font-family: 'Fredoka One'; font-size: 1.5rem;">üéâ ÊÅ≠ÂñúÂèëÁé∞ÈöêËóèÂΩ©ËõãÔºÅ</h3>
            <div class="dialog-content" style="font-size: 1.4rem; color: #5d4037; min-height: auto;">
                Á´üÁÑ∂Ë¢´‰Ω†ÊâæÂà∞‰∫ÜÔºÅ<br>
                Êàë‰ª¨ÁöÑÊöóËØ≠ÊòØÔºö<br>
                <span style="font-size: 2rem; color: #FF8FA3; font-weight: bold; display: block; margin: 15px 0; font-family: 'Fredoka One';">11050830</span>
                Âø´Êù•ÊâæÊàëÂÖëÊç¢Á§ºÁâ©Âêß ü§©
            </div>
            <button class="action-btn" style="float:none;" onclick="closeSecret()">Êî∂Âà∞ üéÅ</button>
        </div>
    </div>
  
    <!-- ÊúÄÁªàÂú∫ÊôØ (Redesigned with Cozy Decor) -->  
    <div id="main-scene">  
        <div class="scene-header">
            <h1 class="final-title">Merry Christmas! Â∞èËÉ°ÂêåÂ≠¶</h1>  
            <div class="final-subtitle">Â±û‰∫é‰Ω†ÁöÑÂèØÁà±ÂÜ¨Â§© ‚ú®</div>
        </div>
        
        <!-- Scene Content Wrapper for auto-scaling -->
        <div id="scene-content-layer">
            <!-- Flying Sleigh (Background) -->
            <div class="sleigh-container" id="sleigh">üéÖü¶åüí®</div>

            <!-- Left Decor -->
            <div class="room-decor-left">
                <div class="wall-frame">üñºÔ∏è</div>
                <div class="fireplace">
                    <div class="mantel"><div class="stocking">üß¶</div></div>
                    <div class="fireplace-inner">
                        <div class="fire">üî•</div>
                    </div>
                </div>
            </div>

            <!-- Right Decor -->
            <div class="room-decor-right">
                <div class="wall-window">
                    <div class="moon-view">üåô</div>
                </div>
                <div class="cozy-bed">
                    <div class="bed-head"></div>
                    <div class="bed-frame"></div>
                    <div class="bed-blanket"></div>
                    <div class="pillow">‚òÅÔ∏è</div>
                    <div class="cat-sleep">üêà</div>
                </div>
            </div>

            <!-- Center Rug -->
            <div class="rug"></div>

            <!-- The Center Stage -->
            <div class="center-stage">
                <!-- The Star Axis -->
                <div class="tree-star">‚≠ê</div>
                
                <!-- Giant Tree -->
                <div class="giant-tree">üéÑ</div>

                <!-- Orbiting Balloon System -->
                <div class="orbit-container">
                    <div class="balloon-wrapper" onclick="handleBalloonClick(event, this)">
                        <div class="pop-bubble">Ê¢¶ÂπªÁÉ≠Ê∞îÁêÉ</div>
                        <div class="hot-air-balloon">
                            <div class="balloon-body"></div>
                            <div class="balloon-ropes"></div>
                            <div class="balloon-basket"></div>
                        </div>
                    </div>
                </div>

                <!-- Dolls at the base -->
                <div class="dolls-wrapper">
                    <div class="doll-item" onclick="interactDoll(this, 'ÂßúÈ•º‰∫∫')">
                        <div class="pop-bubble">Ë¶ÅÂêÉÈ•ºÂπ≤Âêó?</div>üç™
                    </div>
                    <div class="doll-item" onclick="interactDoll(this, 'Â∞èÁÜä')">
                        <div class="pop-bubble">Êä±Êä±~</div>üß∏
                    </div>
                    <div class="doll-item" onclick="interactDoll(this, 'Âú£ËØûËÄÅ‰∫∫')">
                        <div class="pop-bubble">Ho Ho Ho!</div>üéÖ
                    </div>
                    <div class="doll-item" onclick="interactDoll(this, 'Èõ™‰∫∫')">
                        <div class="pop-bubble">Â•ΩÂáâÂø´ÂëÄ</div>‚õÑ
                    </div>
                    <div class="doll-item" onclick="interactDoll(this, 'È©ØÈπø')">
                        <div class="pop-bubble">Âú£ËØûÂø´‰πê!</div>ü¶å
                    </div>
                </div>
            </div>
        </div>
    </div>  
    <div class="snow-ground"></div>  
  
    <script>  
        // ================= Êï∞ÊçÆÈÖçÁΩÆ =================  
        
        // [UPDATED] ‰ΩøÁî® Gitee Áõ¥Èìæ (ÈúÄÈÖçÂêà meta no-referrer ‰ΩøÁî®)
        const PHOTO_MEMORIES = [
            "https://gitee.com/konatatata/material/raw/master/e74e3566a563c744640a12eac2a8ec7f.png",
            "https://gitee.com/konatatata/material/raw/master/cd2319e76c903b0304e99337459f69b2.png",
            "https://gitee.com/konatatata/material/raw/master/ca3e6bb9323f7264aadaa546fcc2f78a.png",
            "https://gitee.com/konatatata/material/raw/master/bfbe9a1ea6b05d767dc8638d8d6e6d5b.png",
            "https://gitee.com/konatatata/material/raw/master/ba6fb3bc26dff7f50583799adc031631.png",
            "https://gitee.com/konatatata/material/raw/master/4e8633b4303b506c640aad08a823b80d.png",
            "https://gitee.com/konatatata/material/raw/master/4c25d1c56fb6738b06ddba8ad941171e.png",
            "https://gitee.com/konatatata/material/raw/master/43d9364bcbbd63e09b7e0d780cf484b4.png",
            "https://gitee.com/konatatata/material/raw/master/3abddf62b53ddde2fdfa4aa20a010ab5.png",
            "https://gitee.com/konatatata/material/raw/master/1379315fd98cbb7084ae18c5c4eed204.png"
        ];

        const INTRO_TEXT = "ËøôÊòØÊàë‰ª¨ËÆ§ËØÜÂêéÊàëÈô™‰Ω†Â∫¶ËøáÁöÑÁ¨¨‰∏Ä‰∏™Âú£ËØûËäÇ\nË∞®‰ª•Ê≠§Á∫™ÂøµÊàë‰ª¨ÁöÑÂèãË∞ä\nÂú®Ëøô‰∏™ÂØíÂÜ∑ÁöÑÂÜ¨Â§©ÔºåÂ∏åÊúõÂèØ‰ª•‰∏∫‰Ω†Â∏¶Êù•‰∏Ä‰∏ùÊ∏©Êöñ";
        const INVITE_TEXT = "HelloÔºåÂú£ËØûÂø´‰πêÔºÅ\nËøôÈáåÊúâ‰∏Ä‰ªΩÁâπÂà´ÁöÑÁ§ºÁâ©ÈÄÅÁªô‰Ω†„ÄÇ\nÂáÜÂ§áÂ•Ω‰∫ÜÂêóÔºü";

        const MESSAGES = [  
            "üçéÂπ≥ÂÆâ", "üí∞Êö¥ÂØå", "üçÄÂ•ΩËøê", "‚ù§Ô∏èLove",   
            "‚ú®Èó™ËÄÄ", "üéÑXmas", "üéÅÁ§ºÁâ©", "üí™Âä†Ê≤π",   
            "üç¨ÁîúËúú", "üê±ÂèØÁà±", "üåàÁæéÂ•Ω", "üöÄ‰∏äÂ≤∏",   
            "üéâÊ¨¢Â∫Ü", "‚ùÑÔ∏èÁ∫ØÊ¥Å", "üåüÂ∏åÊúõ", "üèñÔ∏èËá™Áî±",   
            "üòÑÂºÄÂøÉ", "üêüÈî¶È≤§", "üè†Ê∏©È¶®", "üë≠ÂèãË∞ä",  
            "üç∞Âπ∏Á¶è", "üåôÊôöÂÆâ", "üß∏Èô™‰º¥", "üé∂Âø´‰πê"  
        ];  

        const MEMORIES = [
            { t: "(1/9) üå±", c: "ËøòËÆ∞ÂæóÊàë‰ª¨ÂàöËÆ§ËØÜÁöÑÊó∂ÂÄôÂêóÔºü\nÈÇ£Êó∂ËôΩÁÑ∂Êúâ‰∫õÊãòË∞®Ôºå\n‰ΩÜÊØè‰∏ÄÊ¨°ÂØπËØùÈÉΩËÆ©ÊàëËßâÂæóÁâπÂà´ÊäïÁºò„ÄÇ\nÂÉèÊòØÊò•È£éÂêπËøõ‰∫ÜÂøÉÈáå„ÄÇ", theme: 'sakura' },
            { t: "(2/9) üì±", c: "ÂêéÊù•Êàë‰ª¨Ë∂äÊù•Ë∂äÁÜüÊÇâÔºå\nÂºÄÂßãÂàÜ‰∫´ÂΩºÊ≠§ÁöÑÂñúÊÄíÂìÄ‰πêÔºå\nÂì™ÊÄïÊòØÁîüÊ¥ªÈáåÁöÑËäùÈ∫ªÂ∞è‰∫ãÔºå\n‰πüÊÄªÊÉ≥Á¨¨‰∏ÄÊó∂Èó¥ÂëäËØâ‰Ω†„ÄÇ", theme: 'planes' },
            { t: "(3/9) üéÆ", c: "ÊúÄÂºÄÂøÉÁöÑÂ∞±ÊòØÂíå‰Ω†‰∏ÄËµ∑ÊâìÊ∏∏ÊàèÔºÅ\n‰∏çÁÆ°ÊòØÁéãËÄÖËç£ËÄÄËøòÊòØÂíåÂπ≥Á≤æËã±...\nÊØè‰∏ÄÊ¨°ÁªÑÈòüÂºÄÈªëÔºå\nÈÉΩÊòØÊàë‰ª¨‰∏ìÂ±ûÁöÑÂø´‰πêÊó∂ÂÖâÔºÅ", theme: 'gaming' },
            { t: "(4/9) üí™", c: "ÂΩìÁÑ∂‰πüÊúâ‰∏ÄËµ∑emoÁöÑÊó∂ÂÄôÔºå\n‰∫íÁõ∏ÂêêÊßΩÁîüÊ¥ªÁöÑ‰∏çÊòì„ÄÅÂ∑•‰ΩúÁöÑÁÉ¶ÊÅº„ÄÇ\n‰ΩÜÂè™Ë¶Å‰∫íÁõ∏ÊâìÊâìÊ∞îÔºå\nÂ•ΩÂÉèÂ∞±ÂèàÊúâ‰∫ÜÁªßÁª≠ÂçáÁ∫ßÊâìÊÄ™ÁöÑÂä®Âäõ„ÄÇ", theme: 'warmth' },
            { t: "(5/9) üòÇ", c: "Ë∞¢Ë∞¢‰Ω†ÊÄªÊòØËÉΩÊé•‰ΩèÊàëÁöÑÂ•áÂ•áÊÄ™ÊÄ™Ôºå\nÈÇ£‰∫õÂè™ÊúâÊàë‰ª¨ÊáÇÁöÑÊ¢óÔºå\nÊØèÊ¨°ÊÉ≥Ëµ∑Êù•ÈÉΩ‰ºöÂøç‰∏ç‰ΩèÂò¥Ëßí‰∏äÊâ¨„ÄÇ\nÂíå‰Ω†ËÅäÂ§©ÁúüÁöÑË∂ÖÁ∫ßËΩªÊùæÂø´‰πê„ÄÇ", theme: 'laugh' },
            { t: "(6/9) ‚ùÑÔ∏è", c: "‰∏çÁü•‰∏çËßâÔºå\nÂèà‰∏ÄËµ∑Ëµ∞Ëøá‰∫Ü‰∏Ä‰∏™Êò•Â§èÁßãÂÜ¨Ôºå\nËøéÊù•‰∫ÜËøô‰∏™Êµ™Êº´ÁöÑÂú£ËØûËäÇ„ÄÇ\nÂõ†‰∏∫Êúâ‰Ω†ÔºåËøô‰∏™ÂÜ¨Â§©Â•ΩÂÉè‰πüÊ≤°ÈÇ£‰πàÂÜ∑‰∫Ü„ÄÇ", theme: 'winter' },
            { t: "(7/9) ‚ú®", c: "Âú£ËØûËäÇÂà∞‰∫ÜÔºå\nÊÉ≥ÊääÊòüÊòüÊëò‰∏ãÊù•ÈÄÅÁªô‰Ω†Ôºå\nÊÉ≥Êää‰∏ñÁïå‰∏äÊúÄÁæéÂ•ΩÁöÑÁ•ùÁ¶èÈÉΩÁªô‰Ω†„ÄÇ\nÂ∏åÊúõ‰Ω†ÊØèÂ§©ÈÉΩËÉΩÈÅáËßÅÂ±û‰∫é‰Ω†ÁöÑÂ∞èÁ°ÆÂπ∏„ÄÇ", theme: 'stars' },
            { t: "(8/9) üéà", c: "Ë∞¢Ë∞¢‰Ω†Âá∫Áé∞Âú®ÊàëÁöÑÁîüÂëΩÈáåÔºå\nÊàê‰∏∫ÊàëÁâπÂà´ÁöÑÊúãÂèã„ÄÇ\nÂ∏åÊúõÂú®Êú™Êù•ÁöÑÊó•Â≠êÈáåÔºå\nÊàë‰ª¨ÂèØ‰ª•ÁªßÁª≠‰∏ÄËµ∑Â§ßÁ¨ëÔºå‰∏ÄËµ∑ÂèØÂèØÁà±Áà±„ÄÇ", theme: 'balloons' },
            { t: "(9/9) üéÑ", c: "ÊúÄÂêéÔºå\n‰∫≤Áà±ÁöÑÂ∞èËÉ°ÂêåÂ≠¶Ôºå\nÊÑø‰Ω†Ê∞∏ËøúË¢´Áà±ÂåÖÂõ¥Ôºå‰∏á‰∫ãËÉúÊÑèÔºÅ\nÂú£ËØûÂø´‰πêÔºå‰∏çÊ≠¢Âú£ËØûÔºåÊØèÂ§©ÈÉΩÂø´‰πêÔºÅ", theme: 'gold' }
        ];

        // 99Êù°‰∏çÈáçÂ§çÁöÑÁ•ùÁ¶èËØ≠
        const BALLOON_MESSAGES = [
            "Âú£ËØûÂø´‰πêÔºåÂ§©Â§©ÂºÄÂøÉÔºÅ", "ÂèãË∞äÈïøÂ≠òÔºåÂ≤ÅÂ≤ÅÂπ¥Âπ¥ÔºÅ", "‰Ω†ÊòØÊúÄÂèØÁà±ÁöÑÔºÅ", "ÊÑø‰Ω†Ê∏©ÊöñËøáÂÜ¨ÔºÅ", "Â•ΩËøêÊ≠£Âú®Ê¥æÈÄÅ‰∏≠...",
            "Êö¥ÂØåÊö¥ÂØåÊö¥ÂØåÔºÅ", "ÊÉ≥ÂêÉÁÅ´ÈîÖ‰∫ÜÂêóÔºü", "ËÆ∞ÂæóÂ§öÂñùÁÉ≠Ê∞¥Âì¶~", "Ê∞∏ËøúÂÅöËá™Â∑±ÔºÅ", "ÂâçÁ®ã‰ººÈî¶ÔºåÊú™Êù•ÂèØÊúüÔºÅ",
            "ÊâÄÊúâÁöÑÁæéÂ•ΩÂ¶ÇÊúüËÄåËá≥„ÄÇ", "‰Ω†ÊòØÊúÄÊ£íÁöÑÔºÅ", "Âà´ÁÜ¨Â§úÂï¶ÔºåÂèòÁßÉÂ§¥ÔºÅ", "Âø´‰πê‰∏çÊ≠¢Âú£ËØûËäÇÔºÅ", "ÊÑø‰Ω†Ë¢´‰∏ñÁïåÊ∏©Êüî‰ª•ÂæÖ„ÄÇ",
            "ÂøÉÊÉ≥‰∫ãÊàêÔºÅ", "‰∏á‰∫ãËÉúÊÑèÔºÅ", "Âπ≥ÂÆâÂñú‰πêÔºÅ", "‰øùÊåÅÁÉ≠Áà±ÔºåÂ•îËµ¥Â±±Êµ∑„ÄÇ", "Á¨ëÂè£Â∏∏ÂºÄÔºÅ",
            "ÈÅáËßÅÁöÑÈÉΩÊòØÂ§©ÊÑè„ÄÇ", "Êã•ÊúâÁöÑÈÉΩÊòØÂπ∏Ëøê„ÄÇ", "ÊÑø‰Ω†ÁúºÈáåÊúâÂÖâ„ÄÇ", "ÊÑø‰Ω†ÂøÉ‰∏≠ÊúâÁà±„ÄÇ", "Â•ΩÂøÉÊÉÖÊØè‰∏ÄÂ§©ÔºÅ",
            "‰Ω†ÊòØÊàëÁöÑÂÆùËóèÊúãÂèã„ÄÇ", "Ë¶Å‰∏ÄÁõ¥Âø´‰πê‰∏ãÂéªÂì¶„ÄÇ", "ÁÉ¶ÊÅºÈÄöÈÄöËµ∞ÂºÄÔºÅ", "Ê∞¥ÈÄÜÈÄÄÊï£ÔºÅ", "Èî¶È≤§ÈôÑ‰ΩìÔºÅ",
            "ÂêÉ‰∏çËÉñÔºÅ", "Áù°ÂæóÈ¶ôÔºÅ", "Êï∞Èí±Êï∞Âà∞ÊâãÊäΩÁ≠ãÔºÅ", "Âá∫Èó®ËßÅÂñúÔºÅ", "Êä¨Â§¥ËßÅË¥¢ÔºÅ",
            "ÁîüÊ¥ªÊòéÊúóÔºå‰∏áÁâ©ÂèØÁà±„ÄÇ", "Âõ†‰∏∫Êúâ‰Ω†ÔºåÂÜ¨Â§©ÂæàÊöñ„ÄÇ", "Ë∞¢Ë∞¢‰Ω†ÁöÑÈô™‰º¥„ÄÇ", "Êú™Êù•Êàë‰ª¨‰∏ÄËµ∑Ëµ∞„ÄÇ", "ËãüÂØåË¥µÔºåÂãøÁõ∏ÂøòÔºÅ",
            "Ê∏∏ÊàèÊääÊääCÔºÅ", "Êéí‰ΩçËøûËÉúÔºÅ", "ËêΩÂú∞ÊúâÊû™ÔºÅ", "ÊääÊääÂêÉÈ∏°ÔºÅ", "‰∏ç‰ªÖÂèØÁà±ÔºåËøòÂæàÊúâÊâçÔºÅ",
            "È≠ÖÂäõÊó†ÈôêÔºÅ", "‰∫∫ËßÅ‰∫∫Áà±ÔºåËä±ËßÅËä±ÂºÄ„ÄÇ", "‰Ω†ÊòØÁîµÔºå‰Ω†ÊòØÂÖâÔºÅ", "‰Ω†ÊòØÂîØ‰∏ÄÁöÑHighÂíñ„ÄÇ", "Âø´‰πêÊòüÁêÉÂ±ÖÊ∞ë„ÄÇ",
            "ÊÑø‰Ω†Êã•ÊúâË∂ÖËÉΩÂäõ„ÄÇ", "ÁôæÊØí‰∏ç‰æµ„ÄÇ", "ËØ∏ÈÇ™ÈÄÄÊï£„ÄÇ", "Ê¨ßÊ∞îÊª°Êª°ÔºÅ", "ÂÖÉÊ∞îÊª°Êª°ÔºÅ",
            "ÂÅö‰∏™Âø´‰πêÁöÑÂ∞èÂêÉË¥ß„ÄÇ", "Â•∂Ëå∂Ëá™Áî±ÔºÅ", "ÁÅ´ÈîÖËá™Áî±ÔºÅ", "ÁÉ§ËÇâËá™Áî±ÔºÅ", "ÁîúÁÇπËá™Áî±ÔºÅ",
            "ÊØèÂ§©ÈÉΩË¢´Áà±ÂåÖÂõ¥„ÄÇ", "Êî∂Âà∞Â•ΩÂ§öÂ•ΩÂ§öÁ§ºÁâ©„ÄÇ", "Ë¢úÂ≠êË£Ö‰∏ç‰∏ãÁ§ºÁâ©Âï¶„ÄÇ", "È∫ãÈπøËø∑Ë∑Ø‰∫ÜÔºåÁ§ºÁâ©ËøòÂú®Ë∑Ø‰∏ä„ÄÇ", "Âú£ËØûËÄÅ‰∫∫ÊúÄÂñúÊ¨¢‰Ω†„ÄÇ",
            "Èõ™Ëä±ÊòØÂÜ¨Â§©ÁöÑÊù•‰ø°„ÄÇ", "‰Ω†ÊòØÊàëÁöÑÁã¨ÂÆ∂ËÆ∞ÂøÜ„ÄÇ", "ÂèãË∞äÁöÑÂ∞èËàπÊ∞∏‰∏çÁøª„ÄÇ", "Âπ≤ÊùØüçª", "Cheer up!",
            "Be happy!", "Good luck!", "Merry Christmas!", "Happy New Year!", "Nice to meet you!",
            "ÊÑøÊ¢¶ÈáåÊúâÊòüËæ∞„ÄÇ", "ÈÜíÊù•ÊúâÈò≥ÂÖâ„ÄÇ", "Âò¥Ëßí‰∏äÊâ¨15Â∫¶„ÄÇ", "‰ªäÂ§©‰πüÊòØÂÖÉÊ∞îÊª°Êª°ÁöÑ‰∏ÄÂ§©ÔºÅ", "ÂÜ≤È∏≠ÔºÅ",
            "Âä†Ê≤πÔºåÂ∞èËÉ°ÂêåÂ≠¶ÔºÅ", "Ê≤°Êúâ‰ªÄ‰πàÂèØ‰ª•ÊâìÂÄí‰Ω†„ÄÇ", "Áõ∏‰ø°Ëá™Â∑±„ÄÇ", "‰Ω†ÂÄºÂæóÊúÄÂ•ΩÁöÑ‰∏ÄÂàá„ÄÇ", "Êã•Êä±Êú™Êù•„ÄÇ",
            "‰∏çË¥üÈü∂Âçé„ÄÇ", "Âè™‰∫âÊúùÂ§ï„ÄÇ", "Âø´‰πêËá≥‰∏ä„ÄÇ", "Áü•Ë∂≥Â∏∏‰πê„ÄÇ", "È°∫ÂÖ∂Ëá™ÁÑ∂„ÄÇ",
            "ÈöèÈÅáËÄåÂÆâ„ÄÇ", "ÂøÉ‰πãÊâÄÂêë„ÄÇ", "Á¥†Â±•‰ª•ÂæÄ„ÄÇ", "ÂèØÂèØÁà±Áà±„ÄÇ", "Â•áÂ•áÊÄ™ÊÄ™„ÄÇ",
            "Ê≤°ÊúâÊñáÊ°àÔºåÂè™ÊúâÁ•ùÁ¶è„ÄÇ", "ÊúÄÂêé‰∏ÄÊù°ÔºöÊ∞∏ËøúÂø´‰πêÔºÅ", "ÁâπÂà´ÁöÑÁà±ÁªôÁâπÂà´ÁöÑ‰Ω†„ÄÇ", "ÊÑø‰Ω†‰∏âÂÜ¨Êöñ„ÄÇ", "ÊÑø‰Ω†Êò•‰∏çÂØí„ÄÇ",
            "ÊÑø‰Ω†Â§©ÈªëÊúâÁÅØ„ÄÇ", "ÊÑø‰Ω†‰∏ãÈõ®Êúâ‰ºû„ÄÇ", "ÊÑø‰Ω†Ë∑Ø‰∏äÊúâËâØ‰∫∫Áõ∏‰º¥„ÄÇ", "Âú£ËØûËäÇÂø´‰πêÂëÄÔºÅ"
        ];
        let availableBalloonMsgs = [...BALLOON_MESSAGES];
  
        // ================= Á≥ªÁªüÂèòÈáè =================  
        const bgm = document.getElementById('bgm');
        const musicBtn = document.getElementById('music-control');
        let currentMemIndex = 0;
        window.isUnlocked = false; // [NEW] Global unlock flag
        
        // ================= Ê†∏ÂøÉÈÄªËæëÔºöÂàùÂßãÂåñ‰∏éÈîÅÂÆö =================  
        
        // [Step 1] ÂîØ‰∏ÄÂÖ•Âè£ÔºöDOM Ready Á´ãÂç≥Ê£ÄÊü•
        document.addEventListener('DOMContentLoaded', () => {
            initResponsive();
            
            // Á´ãÂç≥ÊâßË°åÊó∂Èó¥Ê£ÄÊü• - ËøôÊòØÊúÄÈ´ò‰ºòÂÖàÁ∫ß
            initSystemLock();
            
            // ÁªëÂÆöÂºÄÂèëËÄÖÂêéÈó® (Updated: Trigger Password Modal on 1st Click)
            const lockBtn = document.getElementById('lock-btn');
            if(lockBtn) {
                lockBtn.addEventListener('click', () => {
                   // Show Password Modal immediately
                   document.getElementById('bypass-modal').style.display = 'flex';
                   setTimeout(() => document.getElementById('bypass-input').focus(), 100);
                });
            }
        });
        
        // Bypass Logic Functions
        function closeBypass() {
            document.getElementById('bypass-modal').style.display = 'none';
            document.getElementById('bypass-input').value = '';
        }

        function checkBypass() {
            const input = document.getElementById('bypass-input');
            if(input.value === '0803') {
                closeBypass();
                // Start Unlock
                unlockAndStart();
            } else {
                alert('ÊöóÂè∑‰∏çÂØπÂì¶ üòù');
                input.value = '';
            }
        }

        // Ê£ÄÊü•Êó∂Èó¥Âπ∂ÂÜ≥ÂÆöÂéªÁïô
        function initSystemLock() {
            const now = new Date();
            const currentYear = now.getUTCFullYear(); 

            // Beijing is UTC+8.
            // Target is Dec 25 00:00 Beijing Time.
            // In UTC, this is Dec 24 16:00 of the SAME year (prev day).
            
            // 1. Define the target for THIS year
            let targetDate = Date.UTC(currentYear, 11, 24, 16, 0, 0);

            // 2. Define the "End of Christmas Day" for THIS year (Dec 26 00:00 Beijing)
            let endDate = Date.UTC(currentYear, 11, 25, 16, 0, 0);

            const currentTs = now.getTime();

            // Logic:
            // If now is between Start and End -> UNLOCK (It is Christmas!)
            // If now is AFTER End -> Target is NEXT YEAR
            // If now is BEFORE Start -> Target is THIS YEAR (already set)

            if (currentTs >= targetDate && currentTs < endDate) {
                // It is Christmas Day! Unlock immediately.
                unlockAndStart();
                return;
            }

            if (currentTs >= endDate) {
                // We missed it this year, set target to next year
                targetDate = Date.UTC(currentYear + 1, 11, 24, 16, 0, 0);
            }

            // Start monitoring/countdown
            startCountdown(targetDate);
        }

        // ÂÄíËÆ°Êó∂Âæ™ÁéØ
        function startCountdown(targetTs) {
            const layer = document.getElementById('countdown-layer');
            const elD = document.getElementById('cd-d');
            const elH = document.getElementById('cd-h');
            const elM = document.getElementById('cd-m');
            const elS = document.getElementById('cd-s');
            
            // Function to calculate and update UI
            function update() {
                if (window.isUnlocked) return; // [NEW] Stop updating if unlocked

                const now = new Date().getTime();
                const diff = targetTs - now;

                if (diff <= 0) {
                    // Time Reached during wait
                    clearInterval(timer);
                    unlockAndStart(); 
                    return;
                }

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                if(elD) elD.innerText = String(days).padStart(2, '0');
                if(elH) elH.innerText = String(hours).padStart(2, '0');
                if(elM) elM.innerText = String(minutes).padStart(2, '0');
                if(elS) elS.innerText = String(seconds).padStart(2, '0');
            }

            // Run ONCE immediately to prevent 00:00 flash
            update();
            
            // Start interval
            const timer = setInterval(update, 1000);
        }

        // [Step 2] Ëß£ÈîÅÂπ∂ÂêØÂä®Â∫îÁî® (Entry Point for App Logic)
        // Âè™ÊúâËøô‰∏™ÂáΩÊï∞Ë¢´Ë∞ÉÁî®ÔºåÂêéÁª≠ÁöÑÈü≥‰πê„ÄÅÈõ™Ëä±„ÄÅÂä†ËΩΩÊù°Êâç‰ºöÂá∫Áé∞
        function unlockAndStart() {
            // [NEW] Global Flag to stop countdown logic
            window.isUnlocked = true;

            const layer = document.getElementById('countdown-layer');
            if(layer) {
                layer.style.pointerEvents = 'none'; // [FIX] Stop blocking clicks immediately
                layer.style.opacity = '0';
                // Wait for fade out then destroy it
                setTimeout(() => {
                    // FORCE HIDE with priority to fix blocking issue
                    layer.style.setProperty('display', 'none', 'important'); 
                    startLoadingSequence(); // Start App
                    initEnvironmentEffects(); // Start Snow/Music
                }, 800);
            } else {
                // Fallback if layer missing
                startLoadingSequence();
                initEnvironmentEffects();
            }
        }

        // ÂàùÂßãÂåñÁéØÂ¢ÉÁâπÊïà (Èõ™Ëä± + Èü≥‰πê)
        function initEnvironmentEffects() {
            // Start Snow
            setInterval(createSnow, 200);
            
            // Start Music (Attempt Autoplay)
            const attemptPlay = () => {
                bgm.play().then(() => {
                    musicBtn.classList.add('playing'); musicBtn.innerText = 'üéµ';
                }).catch(() => {
                    // Interaction fallback
                    const unlockAudio = () => {
                        bgm.play(); musicBtn.classList.add('playing'); musicBtn.innerText = 'üéµ';
                        document.removeEventListener('click', unlockAudio);
                        document.removeEventListener('touchstart', unlockAudio);
                    };
                    document.addEventListener('click', unlockAudio);
                    document.addEventListener('touchstart', unlockAudio);
                });
            };
            attemptPlay();
        }

        // Âä†ËΩΩÊù°ÈÄªËæë
        function startLoadingSequence() {
            const screen = document.getElementById('loading-screen');
            if(!screen) return;
            screen.style.display = 'flex'; // Ensure visible now
            
            const bar = document.getElementById('loading-bar');
            
            setTimeout(() => bar.style.width = '60%', 200);
            setTimeout(() => bar.style.width = '100%', 1000);

            setTimeout(() => {
                screen.style.pointerEvents = 'none'; // [FIX] Stop blocking clicks
                screen.style.opacity = '0';
                setTimeout(() => screen.style.display = 'none', 800);
                
                // Show Intro Stage
                showStage('stage-0-intro');
                spawnBgIcon();
                
                setTimeout(() => {
                    const introEl = document.getElementById('intro-text');
                    if(introEl) {
                        typeWriter(introEl, INTRO_TEXT, () => {
                            enableBtn('btn-intro');
                        });
                    }
                }, 800);
            }, 1800);
        }

        // [NEW] Responsive System
        function initResponsive() {
            const handleResize = () => {
                const w = window.innerWidth;
                const h = window.innerHeight;
                const debugEl = document.getElementById('res-debug');
                let s = w / 414; 
                const sceneLayer = document.getElementById('scene-content-layer');
                if(sceneLayer) {
                    if (h < 700) {
                        const hScale = h / 800;
                        s = Math.min(s, hScale);
                    }
                    // [FIX] Increase minimum scale to prevent items from becoming too small
                    s = Math.min(Math.max(s, 0.75), 1.3);
                    sceneLayer.style.transform = `scale(${s})`;
                }
                if(debugEl) debugEl.innerText = `Adapt: ${w}x${h} (s:${s.toFixed(2)})`;
            };
            window.addEventListener('resize', handleResize);
            handleResize(); 
        }

        // ================= ÁâπÊïàÂºïÊìé (Theme Engine) =================  
        function applyTheme(theme) {
            const layer = document.getElementById('theme-layer');
            const body = document.body;
            layer.innerHTML = ''; // Ê∏ÖÈô§ÊóßÁâπÊïà
            
            // ÈªòËÆ§ËÉåÊôØÊÅ¢Â§ç
            if(theme === 'default') {
                body.style.backgroundColor = '#FFFBF0';
                document.getElementById('bg-base-layer').style.opacity = '1';
                return;
            }

            // ÈªòËÆ§ËøáÊ∏°Áä∂ÊÄÅ
            document.getElementById('bg-base-layer').style.opacity = '1';
            body.style.backgroundColor = '#FFFBF0';

            switch(theme) {
                case 'sakura': // 1. Ê®±Ëä±
                    body.style.backgroundColor = '#fff0f5'; 
                    createParticles(layer, 'üå∏', 20, 'fx-sakura', 5, 10);
                    break;
                case 'planes': // 2. Á∫∏È£ûÊú∫
                    body.style.backgroundColor = '#e6f7ff'; 
                    createParticles(layer, '‚úàÔ∏è', 6, 'fx-plane', 8, 15);
                    break;
                case 'gaming': // 3. Ê∏∏Êàè
                    document.getElementById('bg-base-layer').style.opacity = '0.1'; 
                    body.style.backgroundColor = '#1a103c'; 
                    const vs = document.createElement('div');
                    vs.className = 'fx-game-vs'; vs.innerText = 'VS';
                    layer.appendChild(vs);
                    const icons = ['üéÆ', '‚ö°', 'üî•', 'üëæ', '‚öîÔ∏è', 'üèÜ'];
                    for(let i=0; i<15; i++) {
                        const p = document.createElement('div');
                        p.className = 'fx-game-icon';
                        p.innerText = icons[Math.floor(Math.random()*icons.length)];
                        p.style.left = Math.random()*90 + 5 + 'vw';
                        p.style.top = Math.random()*90 + 5 + 'vh';
                        p.style.animationDelay = Math.random()*2 + 's';
                        layer.appendChild(p);
                    }
                    break;
                case 'warmth': // 4. ÊöñÈò≥
                    document.getElementById('bg-base-layer').style.opacity = '0.2';
                    body.style.backgroundColor = '#2c3e50';
                    const glow = document.createElement('div');
                    glow.className = 'fx-warm-glow';
                    layer.appendChild(glow);
                    break;
                case 'laugh': // 5. Ê¨¢Á¨ë
                    body.style.backgroundColor = '#fffde7'; 
                    createParticles(layer, ['üòÇ','ü§£','üòπ','üòÜ'][Math.floor(Math.random()*4)], 15, 'fx-laugh', 4, 8, true);
                    break;
                case 'winter': // 6. ËøáÂÜ¨
                    body.style.backgroundColor = '#f0f8ff'; 
                    const frost = document.createElement('div');
                    frost.className = 'fx-frost';
                    layer.appendChild(frost);
                    for(let i=0; i<20; i++) setTimeout(createSnow, i*50);
                    break;
                case 'stars': // 7. ÊòüÁ©∫
                    document.getElementById('bg-base-layer').style.opacity = '0';
                    body.style.backgroundColor = '#0f172a'; 
                    for(let i=0; i<50; i++) {
                        const s = document.createElement('div');
                        s.className = 'fx-star';
                        const sz = Math.random()*3 + 1 + 'px';
                        s.style.width = sz; s.style.height = sz;
                        s.style.left = Math.random()*100 + 'vw'; s.style.top = Math.random()*100 + 'vh';
                        s.style.animationDelay = Math.random()*2 + 's';
                        layer.appendChild(s);
                    }
                    for(let i=0; i<3; i++) {
                        const ss = document.createElement('div');
                        ss.className = 'fx-shooting-star';
                        ss.style.top = Math.random()*30 + 'vh';
                        ss.style.right = Math.random()*30 + 'vw';
                        ss.style.animationDelay = i*2 + 's';
                        layer.appendChild(ss);
                    }
                    break;
                case 'balloons': // 8. Ê∞îÁêÉ
                    createParticles(layer, 'üéà', 12, 'fx-balloon', 6, 12, true);
                    break;
                case 'gold': // 9. ÈáëËâ≤
                    document.getElementById('bg-base-layer').style.opacity = '0.5';
                    body.style.backgroundColor = '#fffbe6';
                    for(let i=0; i<40; i++) {
                        const g = document.createElement('div');
                        g.className = 'fx-gold';
                        g.style.left = Math.random()*100 + 'vw';
                        g.style.animationDuration = Math.random()*2 + 3 + 's';
                        g.style.animationDelay = Math.random()*2 + 's';
                        layer.appendChild(g);
                    }
                    break;
            }
        }

        function createParticles(container, charOrArr, count, className, minDur, maxDur, randomizeChar=false) {
            for(let i=0; i<count; i++) {
                const p = document.createElement('div');
                p.className = className;
                if(randomizeChar && Array.isArray(charOrArr)) {
                    p.innerText = charOrArr[Math.floor(Math.random()*charOrArr.length)];
                } else if (randomizeChar) {
                     p.innerText = charOrArr; 
                     if(className === 'fx-laugh') p.innerText = ['üòÇ','ü§£','üòπ','üòÜ'][Math.floor(Math.random()*4)];
                     if(className === 'fx-balloon') p.style.filter = `hue-rotate(${Math.random()*360}deg)`;
                } else {
                    p.innerText = charOrArr;
                }
                
                p.style.left = Math.random() * 90 + 5 + 'vw';
                const dur = Math.random() * (maxDur - minDur) + minDur;
                p.style.animationDuration = dur + 's';
                p.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(p);
            }
        }

        // ================= Â∏∏ËßÑÈÄªËæë =================  

        function spawnBgIcon() {
            const container = document.getElementById('bg-base-layer');
            const icons = ['üéÑ', 'üéÖ', 'ü¶å', 'üéÅ', 'üîî'];
            setInterval(() => {
                if(container.childElementCount > 10) return;
                const icon = document.createElement('div');
                icon.className = 'floating-icon'; 
                icon.style.cssText = `position:absolute; font-size:3rem; opacity:0.15; filter:blur(2px); user-select:none; animation: floatUp 20s linear infinite;`;
                icon.innerText = icons[Math.floor(Math.random()*icons.length)];
                icon.style.left = Math.random()*90 + 'vw';
                container.appendChild(icon);
                setTimeout(()=>icon.remove(), 20000);
            }, 2000);
            const style = document.createElement('style');
            style.innerHTML = `@keyframes floatUp { 0% { transform: translateY(110vh) rotate(0deg); } 100% { transform: translateY(-10vh) rotate(20deg); } }`;
            document.head.appendChild(style);
        }

        // [Ê†∏ÂøÉ] ‰ºòÂåñÁöÑËΩ¨Âú∫ÈÄªËæë
        function showStage(id) {
            // 1. ÊâæÂà∞ÂΩìÂâçÊøÄÊ¥ªÁöÑÂú∫ÊôØÔºåÊâßË°åÈÄÄÂá∫Âä®Áîª
            const current = document.querySelector('.overlay-stage.active');
            
            const enterNewStage = () => {
                const target = document.getElementById(id);
                if(target) {
                    target.style.display = 'flex';
                    // Âº∫Âà∂ÈáçÁªòÁ°Æ‰øùtransitionÁîüÊïà
                    target.offsetHeight; 
                    target.classList.add('active');
                }
            };

            if (current) {
                current.classList.add('exit'); // Ëß¶ÂèëÈÄÄÂá∫CSSÂä®Áîª
                current.classList.remove('active');
                
                // Á≠âÂæÖCSSËøáÊ∏°ÁªìÊùü (0.5s)
                setTimeout(() => {
                    current.style.display = 'none';
                    current.classList.remove('exit');
                    enterNewStage();
                }, 550);
            } else {
                enterNewStage();
            }
        }

        function typeWriter(element, text, onComplete) {
            element.innerHTML = ""; element.classList.add('typing-cursor');
            let i = 0;
            const t = setInterval(() => {
                if (i < text.length) {
                    const char = text.charAt(i);
                    element.innerHTML += (char === '\n' ? '<br>' : char);
                    i++;
                    element.parentElement.scrollTop = element.parentElement.scrollHeight;
                } else {
                    clearInterval(t);
                    element.classList.remove('typing-cursor');
                    if (onComplete) onComplete();
                }
            }, 30); // [FIX] Faster typing speed (50->30)
        }

        function enableBtn(id) { document.getElementById(id).classList.remove('disabled'); }

        function toggleMusic(e) {
            e.stopPropagation();
            if (bgm.paused) {
                bgm.play(); musicBtn.classList.add('playing'); musicBtn.innerText = 'üéµ';
            } else {
                bgm.pause(); musicBtn.classList.remove('playing'); musicBtn.innerText = 'üö´';
            }
        }

        function startMemories() {
            if(bgm.paused) toggleMusic({stopPropagation:()=>{}});
            showStage('stage-1-memory');
            renderMemory(0);
        }

        function renderMemory(index) {
            currentMemIndex = index;
            const data = MEMORIES[index];
            
            // [UPDATED] Find dialog container and set theme class
            const dialog = document.querySelector('#stage-1-memory .dialog-box');
            if(dialog) {
                // Reset basic class and add theme
                dialog.className = 'dialog-box theme-' + data.theme;
            }
            
            const titleEl = document.getElementById('mem-title');
            const textEl = document.getElementById('mem-text');
            const btn = document.getElementById('btn-mem');

            applyTheme(data.theme);

            // ÂÜÖÂÆπÂàáÊç¢Â∞èÂä®Áîª
            textEl.style.opacity = '0';
            setTimeout(() => {
                textEl.style.opacity = '1';
                titleEl.innerText = data.t;
                btn.classList.add('disabled'); 
                typeWriter(textEl, data.c, () => {
                    enableBtn('btn-mem');
                });
            }, 200);
        }

        function nextMemory() {
            if (currentMemIndex < MEMORIES.length - 1) {
                renderMemory(currentMemIndex + 1);
            } else {
                applyTheme('default'); // ÊÅ¢Â§çÈªòËÆ§ËÉåÊôØ
                // [CHANGED] Go to Photo Slideshow instead of Invite
                startPhotoSlideshow();
            }
        }

        function startHeartAnimation() {
            // ËøôÈáåÁöÑÈÄªËæëÁ®çÊúâ‰∏çÂêåÔºöInvite ÈÄÄÂá∫ÔºåGameLayer ÊµÆÁé∞
            const inviteStage = document.getElementById('stage-2-invite');
            // ÊâãÂä®Ëß¶ÂèëInviteÁöÑÈÄÄÂá∫Âä®Áîª
            inviteStage.classList.add('exit');
            inviteStage.classList.remove('active');
            setTimeout(() => { inviteStage.style.display = 'none'; inviteStage.classList.remove('exit'); }, 600);

            const layer = document.getElementById('game-layer');
            layer.style.display = 'block'; 

            const w = window.innerWidth; const h = window.innerHeight;
            const cx = w / 2; const cy = h / 2;
            
            // [UPDATED] Responsive Scale Calculation for Heart
            // We need to fit x=[-16, 16], y=[-13, 13] into screen with padding.
            // Box radius approx 30px, margin 10px -> Total buffer ~45px.
            const xSpace = (w / 2) - 45;
            const ySpace = (h / 2) - 60;
            
            // Calculate max allowed scale
            const scaleX = xSpace / 16;
            const scaleY = ySpace / 13;
            
            // Use conservative scale, cap at 15 (desktop size)
            const scale = Math.min(scaleX, scaleY, 15);

            const delay = 200; 

            MESSAGES.forEach((msg, i) => {
                const t = (i / MESSAGES.length) * 2 * Math.PI;
                let x = 16 * Math.pow(Math.sin(t), 3);
                let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
                
                const targetX = (x * scale + cx) - 30;
                const targetY = (y * scale + cy) - 30;

                const box = document.createElement('div');
                box.className = 'msg-box';
                box.innerText = msg;
                box.style.left = (cx - 30) + 'px'; box.style.top = (cy - 30) + 'px';
                layer.appendChild(box);
                
                // ÁàÜÁÇ∏ÁâπÊïàÁ≤íÂ≠ê
                createExplosion(cx, cy);

                setTimeout(() => {
                    box.style.left = targetX + 'px';
                    box.style.top = targetY + 'px';
                    box.style.opacity = '1';
                    box.style.transform = 'scale(1)';
                    // ÈöèÊú∫ÂºÄÂßãÂëºÂê∏Âä®ÁîªÔºåÈÅøÂÖçÊï¥ÈΩêÂàí‰∏Ä
                    setTimeout(() => box.classList.add('floating'), 1000 + Math.random() * 1000);
                }, i * delay); 
            });

            const totalTime = (MESSAGES.length) * delay + 2000;
            setTimeout(finishGame, totalTime);
        }

        function createExplosion(x, y) {
            // ÁÆÄÂçïÁöÑÁ≤íÂ≠êÁîüÊàê
            for(let k=0; k<4; k++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.background = ['#FF8FA3','#B5EAD7','#FFE577'][Math.floor(Math.random()*3)];
                p.style.left = x + 'px'; p.style.top = y + 'px';
                
                // ÈöèÊú∫ÊñπÂêë
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 50 + 20;
                p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
                p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
                
                p.style.animation = `explode 0.6s ease-out forwards`;
                document.getElementById('game-layer').appendChild(p);
                setTimeout(()=>p.remove(), 600);
            }
        }

        function finishGame() {
            // ÈöêËóèÊ∏∏ÊàèÂ±Ç
            const layer = document.getElementById('game-layer');
            // ÁÆÄÂçïÊ∏êÈöê
            layer.style.transition = 'opacity 0.8s';
            layer.style.opacity = '0';
            setTimeout(() => { layer.style.display = 'none'; }, 800);
            
            // [CHANGED] Game finished, go to Gift Card (Photos already shown)
            showStage('stage-3-card');
        }

        // [NEW] Photo Slideshow Logic
        function startPhotoSlideshow() {
            // Define function to go to next stage (Invite/Game)
            const nextStage = () => {
                 // [BGM SWITCH] ÂàáÊç¢ËÉåÊôØÈü≥‰πê
                 const bgm = document.getElementById('bgm');
                 if(bgm) {
                     // ÁΩëÊòì‰∫ëÁ∫ØÈü≥‰πêÁõ¥Èìæ -> Gitee MP3
                     bgm.src = "https://gitee.com/konatatata/material/raw/master/Santa's%20Christmas%20Bells%20-%20Jingle%20Bells.mp3";
                     bgm.play().catch(e => console.log("Switch BGM play failed", e));
                 }

                 showStage('stage-2-invite');
                 setTimeout(() => {
                    typeWriter(document.getElementById('invite-text'), INVITE_TEXT, () => {
                        // Ëá™Âä®ÊµÅÁ®ãÔºö1.5ÁßíÂêéËá™Âä®ÂºÄÂßãÊ∏∏Êàè
                        setTimeout(startHeartAnimation, 1500);
                    });
                }, 600);
            };

            if (!PHOTO_MEMORIES || PHOTO_MEMORIES.length === 0) {
                nextStage();
                return;
            }
            
            showStage('stage-photo-gallery');
            const frame = document.getElementById('photo-frame');
            const img = document.getElementById('photo-display');
            let idx = 0;

            // Start animation loop
            const playSlide = () => {
                if (idx >= PHOTO_MEMORIES.length) {
                    // Finished, go to Game Invite
                    nextStage();
                    return;
                }

                // Fade out frame slightly to change image
                frame.style.opacity = '0';
                
                setTimeout(() => {
                    img.src = PHOTO_MEMORIES[idx];
                    // Set a random base rotation for this photo via CSS Variable
                    frame.style.setProperty('--rot', (Math.random() * 6 - 3) + 'deg');
                    
                    // Load image then show
                    img.onload = () => {
                        frame.style.opacity = '1';
                        frame.classList.add('show');
                        idx++;
                        // Show for 3.5 seconds
                        setTimeout(playSlide, 3500);
                    };
                    // Handle load error
                    img.onerror = () => {
                        console.log("Image load failed, skipping");
                        idx++;
                        playSlide();
                    }
                }, 600);
            };

            playSlide();
        }

        // === NEW: Handle Balloon Interaction ===
        function handleBalloonClick(e, wrapper) {
            e.stopPropagation();
            // Check if the click originated from the basket (The secret gift box)
            if (e.target.closest('.balloon-basket')) {
                const modal = document.getElementById('secret-modal');
                modal.style.display = 'flex';
                // Force reflow
                void modal.offsetWidth;
                modal.classList.add('active');
            } else {
                // Regular interaction
                interact('balloon', wrapper);
            }
        }

        function closeSecret() {
            const modal = document.getElementById('secret-modal');
            modal.classList.remove('active');
            setTimeout(() => { modal.style.display = 'none'; }, 600);
        }

        // === NEW: Start Balloon Stars ===
        function startBalloonStars() {
            const balloon = document.querySelector('.balloon-wrapper');
            if(!balloon) return;
            
            // Create a star every 600ms
            setInterval(() => {
                const scene = document.getElementById('main-scene');
                if (!scene || !scene.classList.contains('active')) return;

                const rect = balloon.getBoundingClientRect();
                // Only spawn if visible on screen
                if (rect.top > window.innerHeight || rect.left < -100) return;

                const star = document.createElement('div');
                star.className = 'falling-star';
                star.innerText = ['‚ú®', '‚≠ê', 'üåü'][Math.floor(Math.random()*3)];
                // Add some randomness to position relative to center of balloon
                star.style.left = (rect.left + rect.width / 2 + (Math.random() * 20 - 10)) + 'px';
                star.style.top = (rect.top + rect.height / 2 + 20) + 'px';
                
                document.body.appendChild(star);
                setTimeout(() => star.remove(), 1500);
            }, 600);
        }

        // Interaction handler for final scene
        function interact(type, el) {
            const body = el.querySelector('.hot-air-balloon');
            const bubble = el.querySelector('.pop-bubble');
            
            if(body) {
                body.classList.remove('anim-shake');
                void body.offsetWidth;
                body.classList.add('anim-shake');
            }
            
            // Pick a unique random message
            if (availableBalloonMsgs.length === 0) {
                availableBalloonMsgs = [...BALLOON_MESSAGES];
            }
            const randomIndex = Math.floor(Math.random() * availableBalloonMsgs.length);
            const msg = availableBalloonMsgs.splice(randomIndex, 1)[0];
            
            if(bubble) {
                bubble.innerText = msg;
                bubble.classList.remove('show');
                void bubble.offsetWidth;
                bubble.classList.add('show');
            }

            // Drop a particle
            createExplosion(el.getBoundingClientRect().left + 60, el.getBoundingClientRect().top + 140);
        }
        
        // Generic doll interaction
        function interactDoll(el, name) {
            el.classList.remove('doll-jump');
            void el.offsetWidth;
            el.classList.add('doll-jump');
            
            const bubble = el.querySelector('.pop-bubble');
            if(bubble) {
                bubble.classList.remove('show');
                void bubble.offsetWidth;
                bubble.classList.add('show');
            }
        }

        function startSleighLoop() {
            const s = document.getElementById('sleigh');
            if(!s) return;
            
            const runAnimation = () => {
                s.classList.remove('fly');
                void s.offsetWidth;
                s.classList.add('fly');
                // Schedule next run (animation takes 12s, wait 3s more)
                setTimeout(runAnimation, 15000);
            };
            runAnimation();
        }

        function revealFinal() {
            const cardStage = document.getElementById('stage-3-card');
            // Ëß¶ÂèëÈÄÄÂá∫Âä®Áîª
            cardStage.classList.add('exit');
            cardStage.classList.remove('active');
            
            // ÂºÄÂêØÁôΩÂ±èÈó™ÂÖâ
            const flash = document.getElementById('flash-overlay');
            flash.style.opacity = '1';
            
            // ÈöêËóèÈ°∂ÈÉ®ÁöÑÁÅØÔºà‰∏∫‰∫ÜÁªìÂ±ÄÂπ≤ÂáÄÔºâ
            document.querySelector('.light-rope').classList.add('hidden');

            setTimeout(() => {
                cardStage.style.display = 'none';
                const mainScene = document.getElementById('main-scene');
                mainScene.classList.add('active');
                
                applyTheme('gold'); 
                
                // ÊÖ¢ÊÖ¢Ê∑°Âá∫ÁôΩÂ±èÔºåÊòæÈú≤ÁªìÂ±Ä
                setTimeout(() => { 
                    flash.style.opacity = '0'; 
                    // Start flying animations
                    startSleighLoop();
                    startBalloonStars();
                }, 500);
            }, 1200); 
        }

        function createSnow() {
            const c = document.getElementById('snow-container');
            if (c.childElementCount > 40) return; 
            const s = document.createElement('div');
            s.classList.add('snowflake');
            const size = Math.random() * 8 + 5 + 'px';
            s.style.width = size; s.style.height = size;
            s.style.left = Math.random() * 100 + 'vw';
            s.style.opacity = Math.random() * 0.5 + 0.3;
            const d = Math.random() * 5 + 5 + 's';
            s.style.animation = `fall ${d} linear infinite`;
            c.appendChild(s);
            setTimeout(() => s.remove(), parseFloat(d) * 1000);
        }
    </script>  
</body>  
</html>
